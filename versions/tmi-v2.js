/* global window, console, jQuery, swfobject, Connection, SessionManager, util, INCLUDE_FILE */(function(e,t){if(typeof window.TMI=="undefined"){var n=window.TMI={VERSION:2},r=function(){var e={};e.callback=function(e,t){return function(){return e.apply(t)}},e.randomInt=function(e){return Math.round(e*Math.random())},e.subdomain=window.location.host.split(".")[0];var t=null;e.urlParams=function(){if(t===null){t={};var e=window.location.search.substr(1),n=e.split("&");for(var r=0;r<n.length;++r){var i=n[r].split("=");t[i[0]]=i.length>1?i[1]:""}}return t},e.readCookie=function(t){var n=t+"=",r=window.document.cookie.split(";");for(var i=0;i<r.length;i++){var s=e.string.trim(r[i]);if(s.indexOf(n)===0)return s.substring(n.length,s.length)}return null},e.string={trim:function(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}},e.time={seconds:function(e){return e*1e3}},e.array={join:function(){var e=[];for(var t=0;t<arguments.length;++t)Array.prototype.push.apply(e,arguments[t]);return e},pickRandom:function(e){var t=Math.floor(Math.random()*e.length);return e[t]},shuffle:function(e){var t=e.slice(0),n=t.length,r,i;while(0!==n)r=Math.floor(Math.random()*n),n-=1,i=t[n],t[n]=t[r],t[r]=i;return t},getNextIndex:function(e,t){return(t+1)%e.length}},e.types={};var n=e.types.Promise=function(e){this._jqDeferred=e};n.prototype.state=function(){return this._jqDeferred.state()},n.prototype.done=function(e){return this._jqDeferred.done(e),this},n.prototype.fail=function(e){return this._jqDeferred.fail(e),this},n.prototype.always=function(e){return this._jqDeferred.always(e),this};var r=e.types.SetStore=function(){this._sets={}};return r.prototype.add=function(e,t){this._create(e)[t]=!0},r.prototype.remove=function(e,t){var n=this._get(e);n&&delete n[t]},r.prototype.get=function(e){var t=[],n=this._get(e);if(n)for(var r in n)n.hasOwnProperty(r)&&t.push(r);return t},r.prototype._create=function(e){return this._sets[e]||(this._sets[e]={}),this._sets[e]},r.prototype._get=function(e){return this._sets[e]},e}();n.logging=function(){var e=function(){},t=e,n={},i={DEBUG:1,INFO:2,WARNING:3,ERROR:4,CRITICAL:5},s=i.WARNING,o=function(e){this._opts=e},u="DEBUG: ";o.prototype.debug=function(e){s<=i.DEBUG&&this._log(u+e)};var a="INFO: ";o.prototype.info=function(e){s<=i.INFO&&this._log(a+e)};var f="WARNING: ";o.prototype.warning=function(e){s<=i.WARNING&&this._log(f+e)};var l="ERROR: ";o.prototype.error=function(e){s<=i.ERROR&&this._log(l+e)};var c="CRITICAL: ";o.prototype.critical=function(e){s<=i.CRITICAL&&this._log(c+e)},o.prototype._log=function(e){t(this._opts.prefix+e)};var h={setLogger:function(n){t=typeof n=="function"?n:e},setLevel:function(){var e=(r.urlParams().tmi_log_level||"").toUpperCase();if(e){var t=i[e];if(t)return s=t,function(){}}return function(e){e?s=i[e.toUpperCase()]||i.WARNING:s=i.WARNING}}(),_getLogger:function(e){return n[e]||(n[e]=new o({prefix:"TMI.js ["+e+"] "})),n[e]}},p=window.console;return p&&p.log&&(p.log.apply?h.setLogger(function(){p.log.apply(p,arguments)}):h.setLogger(function(){var e=[];for(var t=0;t<arguments.length;++t)e.push(arguments[t]);p.log(e.join(" "))})),h}();var i=function(){var e=function(){};return e.prototype.on=function(e,t,n){return this._events=this._events||{},this._events[e]=this._events[e]||[],this._events[e].push(t,n),this},e.prototype.off=function(e,t){if(this._events){var n=this._events[e]||[],r=this._events[e]=[];for(var i=0;i<n.length;i+=2)n[i]!==t&&(r.push(n[i]),r.push(n[i+1]))}return this},e.prototype._trigger=function(e){if(this._events){var t=this._events[e]||[];for(var n=1;n<t.length;n+=2)t[n-1].apply(t[n],Array.prototype.slice.call(arguments,1))}return this},e}(),s=function(){var t=n.logging._getLogger("api"),i=function(e){this.baseUrl=e.baseUrl,this.data=e.data,this.headers=e.headers,this._initIframeHack(e.receiverUrl,e.documentDomain)};return i.prototype.get=function(e,t,n){return this._ajax("GET",e,t,n)},i.prototype.post=function(e,t,n){return this._ajax("POST",e,t,n)},i.prototype.put=function(e,t,n){return this._ajax("PUT",e,t,n)},i.prototype.del=function(e,t,n){return this._ajax("DELETE",e,t,n)},i.prototype._initIframeHack=function(t,n){t&&n&&(this._isIframeHackReady=!1,this.requestQueue=[],this.iframe=e("<iframe>").attr("src",t).appendTo("head").get(0),document.domain=n)},i.prototype._iframeHackAjax=function(t){var n=this;t.xhr=function(){return new n.iframe.contentWindow.XMLHttpRequest},t.beforeSend=function(e,t){t.crossDomain=!1},this._isIframeHackReady?e.ajax(t):this.requestQueue.push(t)},i.prototype._onIframeHackReady=function(){this._isIframeHackReady||(this._isIframeHackReady=!0,e.each(this.requestQueue,function(t,n){e.ajax(n)}))},i.prototype._ajax=function(t,n,i,s){var o=new e.Deferred,u=this;return s=s||{},s.headers=s.headers||{},e.extend(s.headers,this.headers),i=i||{},e.extend(i,this.data),t!=="GET"&&t!=="POST"?(s.type="POST",s.headers["X-Http-Method-Override"]=t):s.type=t,s.success&&o.done(s.success),s.error&&o.fail(s.error),e.extend(s,{url:this.baseUrl+n,dataType:"json",cache:!0,global:!1,data:i,success:o.resolve,error:o.reject}),this.iframe?this._iframeHackAjax(s):e.ajax(s),new r.types.Promise(o)},i}(),o=function(){var i=n.logging._getLogger("socket"),s=2,o={},u=1,a=function(e){this._opts=e,this._resetSwfState(),this._shouldConnectAddr=null,this._hasAttemptedConnecting=!1,this._isConnected=!1,this._numLoadAttempts=0,i.info("Loading Flash socket SWF..."),this._embedSocketSwf()};return n._flashSocket={callback:function(e,t,n){setTimeout(function(){var r=o[e];if(r)switch(t){case"loaded":i.debug("Flash socket loaded."),r._onLoaded(n);break;case"connected":i.debug("Flash socket connected."),r._onConnected(n);break;case"closed":i.debug("Flash socket closed."),r._onClosed(n);break;case"data":i.debug("Flash socket received data."),r._onDataReceived(n);break;case"error":i.debug("Flash socket error"),r._onError(n);break;case"exception":i.error("Flash socket threw an exception while calling "+n.method+" on SWF: "+n.message);break;default:i.warning("Invalid socket event: "+t)}else i.error("Invalid socket client ID: "+e)},1)}},a.prototype.connect=function(e,t){this._shouldConnectAddr||(this._shouldConnectAddr={host:e,port:t},this._isSwfLoaded&&this._connectSwfSocket())},a.prototype.close=function(){var e=this._isSwfLoaded&&this._hasAttemptedConnecting;this._reset(),e&&(i.debug("Calling close on SWF."),this._socketSwf.close())},a.prototype.send=function(e,t){this._isSwfLoaded&&this._isConnected?(i.debug("Calling send on SWF."),this._socketSwf.send(e,t)):i.warning("Attempted to send "+e+" over a disconnected Flash socket. Ignoring.")},a.prototype._connectSwfSocket=function(){this._hasAttemptedConnecting=!0,i.debug("Calling connect on SWF."),this._socketSwf.connect(this._shouldConnectAddr.host,this._shouldConnectAddr.port)},a.prototype._onLoaded=function(e){clearTimeout(this._swfLoadedTimeout),this._swfLoadedTimeout=null,this._socketSwf=document.getElementById(this._domId),this._isSwfLoaded=!0,this._shouldConnectAddr&&this._connectSwfSocket()},a.prototype._onConnected=function(e){this._isConnected=!0,this._trigger("onConnected",e)},a.prototype._onClosed=function(e){this._reset(),this._trigger("onClosed",e)},a.prototype._onError=function(e){this._reset(),this._trigger("onError",e)},a.prototype._onDataReceived=function(e){this._trigger("onDataReceived",e)},a.prototype._resetSwfState=function(){delete o[this._clientId],this._clientId=u,o[this._clientId]=this,u+=1,this._domId="tmi_flash_socket_"+this._clientId,this._socketSwf=null,this._isSwfLoaded=!1,this._swfLoadedTimeout=null},a.prototype._reset=function(){this._shouldConnectAddr=null,this._hasAttemptedConnecting=!1,this._isConnected=!1},a.prototype._trigger=function(e,t){i.debug("Triggering "+e+".");var n=this._opts[e];typeof n=="function"&&n(t)},a.prototype._onSwfLoadedTimeout=function(){this._clearSwfLoadedTimeout(),i.error("Could not load the Flash socket SWF. Timed out before receiving the 'loaded' event."),this._numLoadAttempts<s?(i.info("Attempting to reload Flash socket SWF..."),this._resetSwfState(),this._embedSocketSwf()):i.critical("Made "+s+" attempts to load the Flash socket SWF but they each "+"timed out. There will be no more attempts.")},a.prototype._embedSocketSwf=function(){this._numLoadAttempts+=1;var n=this;this._swfLoadedTimeout=setTimeout(r.callback(this._onSwfLoadedTimeout,this),r.time.seconds(10)),e(document).ready(function(){e("<div/>").attr("id",n._domId).appendTo("body");var r={swf:"/tmilibs/JSSocket.swf",domId:n._domId,width:"0px",height:"0px",flashVersion:"10",installSwf:"/widgets/expressinstall.swf",flashVars:{callback:"TMI._flashSocket.callback",clientId:n._clientId},flashParams:{allowScriptAccess:"always",allowNetworking:"all"},htmlAttrs:{name:n._domId,style:"position: absolute;"}};t.embedSWF(r.swf,r.domId,r.width,r.height,r.flashVersion,r.installSwf,r.flashVars,r.flashParams,r.htmlAttrs)})},a.prototype._clearSwfLoadedTimeout=function(){clearTimeout(this._swfLoadedTimeout),this._swfLoadedTimeout=null},a}(),u=function(){var t=n.logging._getLogger("room"),s=3,o=function(e){this._opts=e,this.name=e.name,this._hasFailed=!1,this.isActive=!1,this._numJoinAttempts=0,this._hasJoinedIrcChannel=!1,this._joinTimeout=null,this._joinRetryTimeout=null,this._roomUserModes=new r.types.SetStore,this._connection=null,this._setConnection(e.connection)};return o.prototype=new i,o.prototype.enter=function(){if(this._hasFailed){this._trigger("failure");return}this.isActive?t.warning("Attempted to enter room "+this.name+" again. Ignoring."):(this.isActive=!0,this._connection?this._hasJoinedIrcChannel?t.info("Attempted to enter room "+this.name+" but room has already been "+"entered. Ignoring."):this._joinIrcChannel():t.info("Attempted to enter room "+this.name+" without a connection. "+"When a connection is configured, the room will be entered automatically."))},o.prototype.join=function(){t.warning("Room.join() is deprecated. User room.enter() instead."),this.enter()},o.prototype.exit=function(){this.isActive?(t.info("Clearing session user store"),this._opts.session._users=new f,this.isActive=!1,this._clearJoinTimeouts(),this._numJoinAttempts=0,t.info("Leaving room "+this.name+"."),this._leaveIrcChannel()):t.warning("Attempted to leave room "+this.name+" which has not attempted to join. Ignoring.")},o.prototype.leave=function(){t.warning("Room.leave() is deprecated. Use Room.exit() instead."),this.exit()},o.prototype.list=function(){return e.ajax({url:"https://tmi.twitch.tv/group/user/"+this.name+"/chatters",cache:!1,dataType:"jsonp",timeoutLength:6e3})},o.prototype.getColor=function(e){return t.warning("Room.getColor() deprecated - use Session.getColor() instead."),this._opts.session?this._opts.session._users.getColor(e):this._connection?this._connection._users.getColor(e):null},o.prototype.getEmotes=function(e){return this._opts.session?this._opts.session._users.getEmotes(e):this._connection?this._connection._users.getEmotes(e):null},o.prototype.getLabels=function(e){var t=[];return this._opts.session?t=this._opts.session._users.getSpecials(e):this._connection&&(t=this._connection._users.getSpecials(e)),r.array.join(this.name===e?["owner"]:[],this._roomUserModes.get(e),t)},o.prototype.sendMessage=function(e){if(!this._connection){t.warning('Attempted to send "'+e+'" prior to configuring connection. Ignoring.');return}var n=e.split(" ",1)[0],r=n==="/me",i=this,s;if(n==="/me"||n.charAt(0)!=="/")this._trigger("message",{from:this._connection.nickname,message:r?e.substr(4):e,style:r?"action":undefined,date:new Date});else{if(n==="/ignore"){s=e.split(" ")[1],s&&this.ignoreUser(s);return}if(n==="/unignore"){s=e.split(" ")[1],s&&this.unignoreUser(s);return}}this._connection._send("PRIVMSG "+this._opts.ircChannel+" :"+e)},o.prototype.ignoreUser=function(e){var t=this;this._opts.session.ignoreUser(e).done(function(){t._showAdminMessage("User successfully ignored")}).fail(function(){t._showAdminMessage("There was a problem ignoring that user")})},o.prototype.unignoreUser=function(e){var t=this;this._opts.session.unignoreUser(e).done(function(){t._showAdminMessage("User successfully unignored")}).fail(function(){t._showAdminMessage("There was a problem unignoring that user")})},o.prototype.setColor=function(e){t.warning("Room.setColor() is deprecated. Use Session.setColor() instead.");if(!this._connection)return;this._connection.setColor(e,this.name)},o.prototype.clearChat=function(e){e?this.sendMessage("/clear "+e):this.sendMessage("/clear")},o.prototype.showCommercial=function(e){this.sendMessage("/commercial "+e)},o.prototype.banUser=function(e){this.sendMessage("/ban "+e)},o.prototype.unbanUser=function(e){this.sendMessage("/unban "+e)},o.prototype.modUser=function(e){this.sendMessage("/mod "+e)},o.prototype.unmodUser=function(e){this.sendMessage("/unmod "+e)},o.prototype.timeoutUser=function(e){this.sendMessage("/timeout "+e)},o.prototype.startSlowMode=function(e){this.sendMessage("/slow "+e)},o.prototype.stopSlowMode=function(){this.sendMessage("/slowoff")},o.prototype.startSubscribersMode=function(){this.sendMessage("/subscribers")},o.prototype.stopSubscribersMode=function(){this.sendMessage("/subscribersoff")},o.prototype._showAdminMessage=function(e){this._trigger("message",{style:"admin",from:"jtv",message:e,date:new Date})},o.prototype._fail=function(){this._hasFailed=!0,this._trigger("failure")},o.prototype._setConnection=function(e){if(this._connection){t.error("Attempted to set connection for room "+this.name+" but it "+"already has a connection set. Ignoring.");return}this._connection=e,this._connection&&(this._connection.on("opened",this._onConnOpened,this),this._connection.on("open:retry",this._onConnOpenRetry,this),this._connection.on("open:failed",this._onConnOpenFailed,this),this.isActive&&this._joinIrcChannel())},o.prototype._joinIrcChannel=function(){this._isAllowedToJoin()||t.warning("Attempted to enter room "+this.name+" but have already failed "+s+" attempts to enter. Ignoring.");if(!this._connection.isActive){this._connection.open();return}this._connection.isOpen&&(!this._isAllowedToJoin()||(this._isWaitingToRetryJoin()?t.info("Attempted to enter room "+this.name+" but room is already attempting "+"to enter. Ignoring."):(t.info("Attempting to enter room "+this.name+"."),this._attemptJoinIrcChannel())))},o.prototype._attemptJoinIrcChannel=function(){this._joinTimeout=setTimeout(r.callback(this._onJoinTimeout,this),r.time.seconds(10)),this._numJoinAttempts+=1,this._connection._send("JOIN "+this._opts.ircChannel)},o.prototype._onConnOpened=function(){this.isActive&&(t.info("Connection connected. Attempting to enter room "+this.name+"."),this._attemptJoinIrcChannel()),this._trigger("connection:opened")},o.prototype._onConnOpenRetry=function(e){this._hasJoinedIrcChannel=!1,this._isWaitingToRetryJoin()&&(this._numJoinAttempts-=1),this._clearJoinTimeouts(),this._trigger("connection:retry",e),this._showAdminMessage("Sorry, we were unable to connect to chat. Reconnecting in "+e.delay/1e3+" seconds.")},o.prototype._onConnOpenFailed=function(){this._hasJoinedIrcChannel=!1,this._isWaitingToRetryJoin()&&(this._numJoinAttempts-=1),this._clearJoinTimeouts(),this._trigger("connection:failed")},o.prototype._leaveIrcChannel=function(){this._hasJoinedIrcChannel=!1,this._connection&&(this._connection._send("PART "+this._opts.ircChannel),this._connection._exitedRoom(this))},o.prototype._onIrcMessage=function(e){switch(e.command){case"JOIN":this._onIrcJoin(e);break;case"PRIVMSG":this._onIrcPrivmsg(e);break;case"MODE":this._onIrcMode(e);break;default:t.info("Room "+this.name+" ignoring IRC command "+e.command+".")}},o.prototype._onIrcPrivmsg=function(e){e.style==="admin"&&(e.message.match(/^This room is now in slow mode. You may send messages every \d+ seconds$/)?this._trigger("slow"):e.message.match(/^This room is no longer in slow mode.$/)&&this._trigger("slowoff")),this._opts.session.isIgnored(e.sender)?t.warning("Ignored message from "+e.sender):this._trigger("message",{style:e.style,from:e.sender,message:e.message,date:new Date})},o.prototype._onIrcMode=function(e){switch(e.flag.action){case"add":this._roomUserModes.add(e.user,e.flag.type);break;case"remove":this._roomUserModes.remove(e.user,e.flag.type);break;default:t.warning("Unexpected MODE action: "+e.flag.action+".");return}this._onLabelsChanged(e.user)},o.prototype._onIrcJoin=function(e){this.isActive?(t.info("Successfully entered room "+this.name+"."),this._numJoinAttempts=1,this._clearJoinTimeouts(),this._trigger("entered"),this._trigger("joined"),this._showAdminMessage("Welcome to the chat room!")):(t.warning("Entered room "+this.name+" unexpectedly. Exiting."),this._leaveIrcChannel())},o.prototype._onJoinTimeout=function(){this._clearJoinTimeouts();if(this._isAllowedToJoin()){var e=r.time.seconds(Math.pow(2,this._numJoinAttempts));t.warning("Enter attempt for room "+this.name+" timed out. Attempting to enter again "+"in "+e/1e3+" seconds."),this._joinRetryTimeout=setTimeout(r.callback(this._onJoinRetryTimeout,this),e),this._trigger("enter:retry",{delay:e}),this._trigger("join:retry",{delay:e})}else t.critical("All "+s+" attempts to enter room "+this.name+" failed. "+"No more attempts will be made."),this._trigger("enter:failed"),this._trigger("join:failed")},o.prototype._onJoinRetryTimeout=function(){this._clearJoinTimeouts(),this._attemptJoinIrcChannel()},o.prototype._onLabelsChanged=function(e){this._trigger("labelschanged",e)},o.prototype._onClearChat=function(e){this._trigger("clearchat",e)},o.prototype._isWaitingToRetryJoin=function(){return this._joinTimeout!==null||this._joinRetryTimeout!==null},o.prototype._isAllowedToJoin=function(){return this._numJoinAttempts<=s},o.prototype._clearJoinTimeouts=function(){clearTimeout(this._joinTimeout),this._joinTimeout=null,clearTimeout(this._joinRetryTimeout),this._joinRetryTimeout=null},o}(),a=function(){var t=n.logging._getLogger("irc"),r={CLEARCHAT:!0,EMOTESET:!0,SPECIALUSER:!0,USERCOLOR:!0,HISTORYEND:!0},i=function(t){t=e.trim(t);var n={prefix:null,command:null,params:null,trailing:null},r=-1;t.charAt(0)===":"&&(r=t.indexOf(" "),n.prefix=t.substr(1,r-1));var i=t.indexOf(" :");i>=0?n.trailing=t.substr(i+2):i=t.length;var s=(n.trailing||"").match(/\u0001ACTION (.*)\u0001/);s&&(n.style="action",n.action=s[1]);var o=t.substr(r+1,i-r-1).split(" ");return n.command=o[0],o.length>1&&(n.params=o.slice(1)),n},s=function(e){if(!e.prefix)return null;var t=e.prefix.indexOf("!");return t>=0?e.prefix.substr(0,t):e.prefix},o=function(e){if(e&&e.length==2){var n;switch(e.charAt(0)){case"+":n="add";break;case"-":n="remove";break;default:n=null}if(n){var r;switch(e.charAt(1)){case"o":r="mod";break;default:n=null}if(r)return{action:n,type:r}}}throw t.warning("Invalid MODE flag: "+e),"Invalid MODE flag: "+e};return{channel:function(e){return"#"+e},isChannel:function(e){return e&&e.charAt(0)==="#"},parseMessage:function(n){try{var r=i(n),u=s(r),a=e.extend({sender:u},r);u==="jtv"?a.style="admin":u==="twitchnotify"&&(a.style="notification");var f=function(t){return e.extend(t,a)};switch(r.command){case"JOIN":a=f({target:r.params[0]});break;case"PRIVMSG":a=f({target:r.params[0],message:r.action||r.trailing});break;case"MODE":a=f({target:r.params[0],flag:o(r.params[1]),user:r.params[2]});break;case"PING":case"001":case"002":case"003":case"004":case"375":case"372":case"376":break;default:t.warning("Could not parse IRC message: "+r.command+".")}return a}catch(l){throw t.error('Failed parsing IRC message "'+n+"'."),l}},parseTmiPrivmsg:function(t){var n=t.split(" ",2),i=n[0],s=n[1],o=e.trim(t.substr((i||"").length+(s||"").length+1));if(r[i]){var u=null;switch(i){case"EMOTESET":u=e.parseJSON;break;default:u=String}return{type:i,user:s,payload:u(o)}}return{payload:t}}}}(),f=function(){var e=function(){this._users={},this._specials=new r.types.SetStore};return e.COLORS=["#FF0000","#0000FF","#008000","#B22222","#FF7F50","#9ACD32","#FF4500","#2E8B57","#DAA520","#D2691E","#5F9EA0","#1E90FF","#FF69B4","#8A2BE2","#00FF7F"],e.prototype.setColor=function(e,t){this._user(e).color=t},e.prototype.getColor=function(e){return this._user(e).color},e.prototype.setEmotes=function(e,t){this._user(e).emotes=t},e.prototype.getEmotes=function(e){return this._user(e).emotes},e.prototype.addSpecial=function(e,t){this._specials.add(e,t)},e.prototype.getSpecials=function(e){return this._specials.get(e)},e.prototype._user=function(e){return this._users[e]||(this._users[e]={}),this._users[e]},e}(),l=function(){var t=n.logging._getLogger("conn"),s=!0,l="\r\n",c=[/[\r\n]+/,String.fromCharCode(0)],h=8,p=function(e){var t=this;this._opts=e,this.nickname=e.nickname,this._addrs=r.array.shuffle(e.addrs);if(!this._opts.session){var n=function(){};this._opts.session={_onUserColorChanged:n,_onUserEmotesChanged:n,_onUserSpecialAdded:n}}this._socket=new o({onConnected:function(e){t._onSocketConnected(e)},onClosed:function(e){t._onSocketClosed(e)},onError:function(e){t._onSocketConnectFailed(e)},onDataReceived:function(e){t._onSocketDataReceived(e)}}),this.isActive=!1,this.isOpen=this.isConnected=!1,this._wasCloseCalled=!1,this._numSocketConnectAttempts=0,this._retryConnectionTimeout=null,this._users=new f,this._rooms={},this._currentAddressIndex=0};return p.prototype=new i,p.prototype.open=function(){this._wasCloseCalled=!1,this.isActive||(t.info("Connecting..."),this.isActive=!0,this._isReadyToConnect()&&this._connectToNextAddress())},p.prototype.connect=function(){t.warning("Connection.connect() is deprecated. Use open() instead."),this.open()},p.prototype.close=function(){this.isActive&&t.info("Closing connection..."),this.isActive=this.isOpen=this.isConnected=!1,this._wasCloseCalled=!0,this._stopConnecting(),this._socket.close()},p.prototype.getRoom=function(e){var n=a.channel(e);if(!this._rooms.hasOwnProperty(n)){t.info("Creating new room: "+e+".");var r=new u({name:e,ircChannel:n});this._addRoom(r)}return this._rooms[n]},p.prototype.getColor=function(e){return this._users.getColor(e)},p.prototype.setColor=function(e,n){t.warning("Connection.setColor() is deprecated."),this._setColor(e)},p.prototype._setColor=function(e){this._send("PRIVMSG "+a.channel(this.nickname)+" :/color "+e)},p.prototype._addRoom=function(e){this._rooms[e._opts.ircChannel]=e,e._setConnection(this)},p.prototype._exitedRoom=function(t){var n=this,r=e.grep(this._rooms,function(e){return e.isActive});r.length===0&&this.close()},p.prototype._onSocketConnected=function(e){t.debug("Socket connected.");if(this.isActive){var n=this._addrs[this._currentAddressIndex];t.info("Successfully opened connection to "+n.host+":"+n.port+". Attempting to register with IRC server."),this._send("TWITCHCLIENT 2"),this._send("PASS "+this._opts.password),this._send("NICK "+this._opts.nickname)}else t.warning("Socket connected but connection is not active. Closing socket..."),this._socket.close()},p.prototype._onSocketConnectFailed=function(e){t.debug("Socket connect failed."),this.isOpen=this.isConnected=!1,this.isActive?this._connectionFailed("Unable to connect."):this._wasCloseCalled&&(t.info("Connection closed."),this._connectionClosed())},p.prototype._onSocketClosed=function(e){t.debug("Socket closed.");var n=this.isOpen;this.isOpen=this.isConnected=!1,this.isActive?this._connectionFailed(n?"Connection closed unexpectedly.":"Unable to connect."):this._wasCloseCalled&&(t.info("Connection closed."),this._connectionClosed())},p.prototype._onSocketDataReceived=function(e){t.debug("Socket data received: "+e.data);var n=a.parseMessage(e.data);if(a.isChannel(n.target))this._rooms[n.target]._onIrcMessage(n);else switch(n.command){case"PRIVMSG":var r=a.parseTmiPrivmsg(n.message);r&&(r.style=n.style,r.target=n.target,this._handleTmiPrivmsg(r));break;case"PING":this._send("PONG");break;case"004":this._ircRegistered();break;default:}},p.prototype._handleTmiPrivmsg=function(n){switch(n.type){case"USERCOLOR":this._opts.session._onUserColorChanged(n.user,n.payload),this._users.setColor(n.user,n.payload),this._trigger("colorchanged",n.user);break;case"SPECIALUSER":this._opts.session._onUserSpecialAdded(n.user,n.payload),this._users.addSpecial(n.user,n.payload),e.each(this._rooms,function(e,t){t._onLabelsChanged(n.user)});break;case"EMOTESET":this._opts.session._onUserEmotesChanged(n.user,n.payload),this._users.setEmotes(n.user,n.payload);break;case"HISTORYEND":break;case"CLEARCHAT":t.info("Don't know what channel, temporarily sending to all rooms!"),e.each(this._rooms,function(e,t){t._onClearChat(n.user)});break;default:t.info("Don't know what channel, temporarily sending to all rooms!"),e.each(this._rooms,function(e,t){t._onIrcPrivmsg({style:n.style,message:n.payload})})}},p.prototype._ircRegistered=function(){t.info("IRC connected."),this._numSocketConnectAttempts=1,this.isOpen=this.isConnected=!0,this._trigger("opened"),this._trigger("connected")},p.prototype._connectionClosed=function(){this._wasCloseCalled=!1,this._trigger("closed")},p.prototype._connectionFailed=function(e){if(this._numSocketConnectAttempts<h){var n=r.time.seconds(Math.pow(2,this._numSocketConnectAttempts));this._retryConnectionTimeout=setTimeout(r.callback(this._retryConnecting,this),n),t.warning(e+" Attempting to connect again in "+n/1e3+" seconds..."),this._trigger("open:retry",{delay:n}),this._trigger("connect:retry",{delay:n})}else t.critical("Connection failed repeatedly after "+this._numSocketConnectAttempts+" connection attempts. "+"There will be no more attempts to connect."),this._stopConnecting(),this._trigger("open:failed"),this._trigger("connect:failed")},p.prototype._retryConnecting=function(){this._stopConnecting(),this._connectToNextAddress()},p.prototype._stopConnecting=function(){clearTimeout(this._retryConnectionTimeout),this._retryConnectionTimeout=null},p.prototype._isReadyToConnect=function(){return this._retryConnectionTimeout===null&&this._numSocketConnectAttempts<h},p.prototype._send=function(e){var n=e;for(var r=0;r<c.length;++r)n=n.replace(c[r],"");t.debug("Sending: "+n),this._socket.send(n+l,s)},p.prototype._connectToNextAddress=function(){var e=this._getNextAddress();this._numSocketConnectAttempts+=1,t.info("Connecting to socket with address "+e.host+":"+e.port),this._socket.connect(e.host,e.port)},p.prototype._getNextAddress=function(){return this._currentAddressIndex=r.array.getNextIndex(this._addrs,this._currentAddressIndex),this._addrs[this._currentAddressIndex]},p}(),c=function(){var t=n.logging._getLogger("cluster"),o=function(e){this._opts=e,this.nickname=e.nickname,this._twitchApi=this._initTwitchApi(),this._tmiApi=this._initTmiApi(),this._connections={},this._ignored={},this._rooms={},this._users=new f,this._fetchIgnored()};return o.prototype=new i,o.prototype.getRoom=function(e){if(!this._rooms.hasOwnProperty(e)){var t=new u({session:this,name:e,ircChannel:a.channel(e)});this._rooms[e]=t;var n=this,r=this._getConnectionForRoom(e);r.done(function(e){e._addRoom(t)}),r.fail(function(r){t._fail(),delete n._rooms[e]})}return this._rooms[e]},o.prototype.ignoreUser=function(t){var n=e.Deferred(),i=this;return this._twitchApi.put("/kraken/users/"+this.nickname+"/blocks/"+t).done(function(){i._ignored[t.toLowerCase()]=!0,n.resolve()}).fail(function(e){n.reject()}),new r.types.Promise(n)},o.prototype.isIgnored=function(e){return e&&(e=e.toLowerCase()),!!this._ignored[e]},o.prototype.unignoreUser=function(t){var n=e.Deferred(),r=this;return this._twitchApi.del("/kraken/users/"+this.nickname+"/blocks/"+t).done(function(){delete r._ignored[t.toLowerCase()],n.resolve()}).fail(function(e){n.reject()}),n},o.prototype.setColor=function(t){var n=this;e.each(this._connections,function(e,n){n._setColor(t)})},o.prototype.getColor=function(e){var t=this._users.getColor(e);return t||(t=r.array.pickRandom(f.COLORS),this._users.setColor(e,t)),t},o.prototype._initTwitchApi=function(){var e={beta:"betaapi.twitch.tv",localhost:"localhost.twitch.tv:3000",staging:"stagingapi.twitch.tv"}[r.subdomain]||"api.twitch.tv",t=window.location.protocol+"//"+e,n=new s({baseUrl:t,data:{on_site:"1"},documentDomain:"twitch.tv",headers:{Accept:"application/vnd.twitchtv.v2+json","Twitch-Api-Token":r.readCookie("api_token")},receiverUrl:t+"/assets/tmi_crossdomain_receiver.html"});return window.TMI._twitchIframeReady=function(){n._onIframeHackReady()},n},o.prototype._initTmiApi=function(){var e={staging:"http://tmi-staging.twitch.tv"}[r.subdomain]||"https://tmi.twitch.tv";return r.urlParams().hasOwnProperty("tmi_api_production")&&(e="https://tmi.twitch.tv"),new s({baseUrl:e})},o.prototype._fetchIgnored=function(){var t=this;this._twitchApi.get("/kraken/users/"+this.nickname+"/blocks",{limit:500}).done(function(n){e.each(n.blocks,function(e,n){t._ignored[n.user.name.toLowerCase()]=!0})})},o.prototype._getConnectionForRoom=function(n){var i=e.Deferred(),s=this,o=this._getRoomInfo(n);return o.done(function(e){t.info("Retrieved room info for "+n+".");var o=e.addrs;r.urlParams().tmi_host&&r.urlParams().tmi_port&&(o=[{host:r.urlParams().tmi_host,port:r.urlParams().tmi_port}]);if(!s._connections.hasOwnProperty(e.cluster)){var u=new l({session:s,nickname:s.nickname,password:s._opts.password,addrs:o});s._addConnection(e.cluster,u)}i.resolve(s._connections[e.cluster])}),o.fail(function(){t.error("Could not retrieve room info for "+n+"."),i.reject()}),new r.types.Promise(i)},o.prototype._getRoomInfo=function(n){var i=e.Deferred(),s=e.ajax({type:"GET",url:"https://api.twitch.tv/api/channels/"+n+"/chat_properties?oauth_token="+this._opts.oauthToken,dataType:"jsonp"});return s.done(function(r){var s=[];e.each(r.chat_servers||[],function(e,r){var i=r.split(":");try{s.push({host:i[0],port:parseInt(i[1])})}catch(o){t.error("Invalid chat server specification "+r+" for room "+n+".")}});if(s.length===0){t.error("No chat servers returned for room "+n+"."),i.reject();return}i.resolve({cluster:r.eventchat?"event":"prod",addrs:s})}),s.fail(i.reject),new r.types.Promise(i)},o.prototype._addConnection=function(e,n){t.info("Adding connection for cluster "+e+" to session."),this._connections[e]=n},o.prototype._onUserColorChanged=function(e,t){this._users.setColor(e,t),this._trigger("colorchanged",e)},o.prototype._onUserEmotesChanged=function(e,t){this._users.setEmotes(e,t)},o.prototype._onUserSpecialAdded=function(t,n){this._users.addSpecial(t,n),e.each(this._rooms,function(e,n){n._onLabelsChanged(t)})},o}(),h=n.logging._getLogger("tmi");n.createConnection=function(e){h.warning("TMI.createConnection() is deprecated. Use TMI.createSession()");var t="justinfan"+r.randomInt(999999),n="blah";e.username&&e.oauthToken&&(t=e.username,n="oauth:"+e.oauthToken);var i=e.addrs;return r.urlParams().tmi_host&&r.urlParams().tmi_port&&(i=[{host:r.urlParams().tmi_host,port:r.urlParams().tmi_port}]),new l({nickname:t,password:n,addrs:i})},n.createSession=function(e){var t="justinfan"+r.randomInt(999999),n="blah";return e.username&&e.oauthToken&&(t=e.username,n="oauth:"+e.oauthToken),new c({nickname:t,password:n,oauthToken:e.oauthToken})}}})(jQuery,swfobject);
