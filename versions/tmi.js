(function(e,t){window.TMI=window.TMI||function(){function n(){}function r(){this._env={},this._rooms={},this._ircSWF=null,this._ircSWFDeferred=e.Deferred(),this._flash=new s({conn:this})}function i(e){this._conn=e.conn,this._roomName=e.roomName}function s(e){this._conn=e.conn,this._eventsQueue=[],this._eventsQueueTimeoutHandle=null}return n.prototype.on=function(t,n){e(this).on(t,n)},n.prototype.off=function(t,n){e(this).off(t,n)},n.prototype.trigger=function(t,n){e(this).triggerHandler(t,n)},r.prototype=new n,r.prototype.updateEnv=function(e){this._env=e},r.prototype.connect=function(e){var t=this;this._getIrcSWF().done(function(n){t._ircSWF=n,t._ircSWF.connect(e.roomName,t._env.userLogin,"oauth:"+t._env.oauthToken);if(!t._rooms.hasOwnProperty(e.roomName)){var r=new i({conn:t,roomName:e.roomName});t._rooms[e.roomName]=r}e.success(t._rooms[e.roomName])}).fail(e.failure)},r.prototype.disconnect=function(){this._ircSWF&&this._ircSWF.disconnect()},r.prototype._onEvent=function(e,t){this.trigger(e,[t])},r.prototype._connectionInfo=function(){switch(this._env.environment){case"production":return{hosts:["199.9.253.199","199.9.253.210","199.9.250.229","199.9.250.239"],ports:["80","443"]};case"event":return{hosts:["199.9.252.26","199.9.251.213"],ports:["80","443"]};case"development":return{hosts:["127.0.0.1"],ports:["6667"]};default:throw"Invalid TMI environment: "+this._env.environment}},r.prototype._getIrcSWF=function(){if(e("#site_chat_flash").length===0){e("html").append('<div id="site_chat_flash"/>');var n={swf:"/widgets/site_chat.swf",domID:"site_chat_flash",width:"0px",height:"0px",flashVersion:"9",installSWF:"/widgets/expressinstall.swf",flashVars:{show_admin:null,onsite:!0,js_interface:"TMI._flash",hostname:"www.twitch.tv",message_batching:!0},flashParams:{allowScriptAccess:"always",allowNetworking:"all"},htmlAttrs:{name:"site_chat_flash",style:"position:absolute;"}};t.embedSWF(n.swf,n.domID,n.width,n.height,n.flashVersion,n.installSWF,n.flashVars,n.flashParams,n.htmlAttrs)}return this._ircSWFDeferred.promise()},i.prototype.join=function(){this._conn._ircSWF.join(this._roomName)},i.prototype.who=function(e){this._conn._ircSWF.who(e)},i.prototype.sendMessage=function(e){this._conn._ircSWF.send_channel_message(e)},i.prototype.sendAction=function(e){this._conn._ircSWF.send_channel_action(e)},i.prototype.sendCommand=function(e){this._conn._ircSWF.send_command(e)},i.prototype.debugOn=function(){this._conn._ircSWF.debugOn()},s.prototype.set_loaded=function(){if(this._conn._ircSWFDeferred.state()==="pending"){var t=e("#site_chat_flash")[0];this._conn._ircSWFDeferred.resolve(t)}},s.prototype.get_servers=function(){return this._conn._connectionInfo().hosts},s.prototype.get_ports=function(){return this._conn._connectionInfo().ports},s.prototype.get_darklaunch=function(){return Math.random()<SiteOptions.chat_darklaunch_pct},s.prototype.onChat=function(e,t){switch(e){case"batch":var n=t;this._addEventsToQueue(n),this._handleQueuedEvents();break;default:throw"Invalid event: "+e+". Only 'batch' events expected."}},s.prototype._addEventsToQueue=function(e){this._eventsQueue.push.apply(this._eventsQueue,e)},s.prototype._handleQueuedEvents=function(){if(this._eventsQueueTimeoutHandle===null){var e=this;this._eventsQueueTimeoutHandle=setTimeout(function(){e._eventsQueueTimeoutHandle=null;var t=e._eventsQueue;e._eventsQueue=[];for(var n=0;n<t.length;n++){var r=t[n];try{e._conn._onEvent(r.event,r.info)}catch(i){console.warn("Error handling TMI event ["+r.event+"] "+i)}}},1)}},new r}()})(jQuery,swfobject);
